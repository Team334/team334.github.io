---
layout: default
---

<link rel="stylesheet" href="{{ site.url }}/assets/css/layout/liveblog.css">
<link rel="shortcut icon" type="image/png" href="{{ site.url }}/assets/img/favicon.png">
<div class="container">
    <div class="content">
        <h3>Your UID is <span id="UID"></span></h3>
        <h3>
            Event Information:
        </h3>

        <label for="inp" class="inp">
            <input type="text" id="background-img" placeholder="&nbsp;">
            <span class="label">Background</span>
            <span class="border"></span>
        </label>
        <label for="inp" class="inp">
            <input type="text" id="location" placeholder="&nbsp;">
            <span class="label">Location</span>
            <span class="border"></span>
        </label>
        <label for="inp" class="inp">
            <input type="text" id="brief" placeholder="&nbsp;">
            <span class="label">Brief</span>
            <span class="border"></span>
        </label>
        <label for="inp" class="inp">
            <input type="text" id="flagship" placeholder="&nbsp;">
            <span class="label">Flagship</span>
            <span class="border"></span>
        </label>
        <button id="updateMeta" style="height:auto; width: auto;" onclick="updateMeta()">Update info</button>

        <br>
        <center><button id="live" onclick="toggleLiveStatus()">LIVE</button></center>
        <h3>
            Event Feed:
        </h3>
        <div class="chatbox">
            <span>Posting as: </span><input id="author" type="text" /> <span class="event-title">Troy 2019</span>
            <div class="posts">
                <div id="p1"></div>
            </div>
            <div>
                <input id="isPinned" type="checkbox" />
                <input type="text" id="pinnedMessage" /><br>
                <input type="text" id="messageType" />
            </div>
            <div style="display:flex">
                <input type="text" id="newMessage" />
                <button onclick="createNewPost()" style="height:auto; width: auto; font-size: 1em;">Post</button>
            </div>
        </div>
        <h3>
            Add TBA score:
        </h3>
        <div id="tba-matches" class="card">
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/5.8.3/firebase.js"></script>
<script>
    // Initialize Firebase
  var config = {
    apiKey: "AIzaSyC_lgb2HCIRVHpfb5gO0SEyp7vcQ8aedm8",
    authDomain: "liveblog-90921.firebaseapp.com",
    databaseURL: "https://liveblog-90921.firebaseio.com",
    projectId: "liveblog-90921",
    storageBucket: "liveblog-90921.appspot.com",
    messagingSenderId: "586362346563"
  };
  firebase.initializeApp(config);

  window.params = function(){
    var params = {};
    var param_array = window.location.href.split('?')[1].split('&');
    for(var i in param_array){
        x = param_array[i].split('=');
        params[x[0]] = x[1];
    }
    return params;
}();
</script>
<script src="https://cdn.firebase.com/libs/firebaseui/3.4.1/firebaseui.js"></script>
<script async src="//www.instagram.com/embed.js"></script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.4.1/firebaseui.css" />
<script>
    firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
            document.getElementById('UID').innerHTML = user.uid
        } else {
            console.log("fuck we don't have user")
        }
    });

    EVENT_NAME = window.params.event
    var TBA_EVENT;
    var TBA_RESPONSE;
    document.querySelector('.event-title').innerHTML = EVENT_NAME;
    IS_LIVE = 0;
    var dataUpdate = firebase.database().ref(EVENT_NAME + '/Posts');
    var pinUpdate = firebase.database().ref(EVENT_NAME + '/Pinned');


    dataUpdate.on('child_added', function (childSnapshot, prevChildKey) {
        p = childSnapshot.val();
        el = document.createElement('div')
        el.className = "card post-card";
        el.id = p.ID;
        dte = new Date(parseInt(p.ID));
        el.innerHTML =
            `
                <div class="overview">
                    <div class="post">
                        <span class="post-author">
                            <span class="author-name">` +
            p.ID + " - " + p.Author + `</span>
                            <span class="time">` + ('0' + dte.getMonth())
            .slice(-2) + '.' + ('0' + dte.getDay()).slice(-2) + '.' + ('0' + dte.getYear()).slice(-2) + ' ' + (
                '0' + dte.getHours()).slice(-2) + ':' + ('0' + dte.getMinutes()).slice(-2) + ':' + ('0' + dte.getSeconds())
            .slice(-2) + `</span>
                            ` + ((p.Pinned) ?
                '<a title="Back to Highlights" href="#highlights"><i class="fa fa-thumb-tack"></i></span></a>' :
                "") +
            `
                        </span><button class="edit" onclick="ActivateEdit(this)" style="height:auto; width: auto; font-size: 1em;">Edit</button><br>
                        <span class="post-content">
                            ` +
            p.Post +
            `
                        </span>
                    </div>
                </div>
            `;
        el.appendAfter(document.querySelector('#p1'))
    });

    dataUpdate.on('child_changed', function (childSnapshot, prevChildKey) {
        p = childSnapshot.val();
        el = document.getElementById(p.ID);
        dte = new Date(parseInt(p.ID));
        el.innerHTML =
            `
            <div class="overview">
                <div class="post">
                    <span class="post-author">
                        <span class="author-name">` +
            p.ID + " - " + p.Author + `</span>
                        <span class="time">` + ('0' + dte.getMonth())
            .slice(-2) + '.' + ('0' + dte.getDay()).slice(-2) + '.' + ('0' + dte.getYear()).slice(-2) + ' ' + (
                '0' + dte.getHours()).slice(-2) + ':' + ('0' + dte.getMinutes()).slice(-2) + ':' + ('0' + dte.getSeconds())
            .slice(-2) + `</span>
                        ` + ((p.Pinned) ?
                '<a title="Back to Highlights" href="#highlights"><i class="fa fa-thumb-tack"></i></span></a>' :
                "") +
            `
                    </span><button class="edit" onclick="ActivateEdit(this)" style="height:auto; width: auto; font-size: 1em;">Edit</button><br>
                    <span class="post-content">
                        ` +
            p.Post + `
                    </span>
                </div>
            </div>
            `;
    });

    dataUpdate.on('child_removed', function (childSnapshot, prevChildKey) {
        p = childSnapshot.val();
        el = document.getElementById(p.ID);
        el.remove();
    });

    function ActivateEdit(el) {
        content = el.nextSibling.nextSibling.nextSibling.innerHTML;
        el.nextSibling.nextSibling.nextSibling.innerHTML = '<textarea>' + content +
            '</textarea><button class="edit" onclick="SubmitEdit(this)" style="height:auto; width: auto; font-size: 1em;">Edit</button><br><br><button class="edit" onclick="DeleteThis(this)" style="height:auto; width: auto; font-size: 1em;">Delete</button>';
    }

    function SubmitEdit(el) {
        content = el.previousSibling.value;
        pid = el.parentElement.parentElement.parentElement.parentElement.id;
        dataUpdate.child(pid).update({
            Post: content,
            Edited: +new Date(),
        })
    }

    function DeleteThis(el) {
        ref = el.parentElement.parentElement.parentElement.parentElement.id;
        dataUpdate.child(ref).remove();
        pinUpdate.child(ref).remove();

    }

    function createNewPost() {
        timenow = +new Date();
        dataUpdate.child(timenow).set({
            Author: document.getElementById("author").value,
            Pinned: document.getElementById("isPinned").checked,
            ID: timenow,
            Post: document.getElementById("newMessage").value,
            type: document.getElementById("messageType").value,
        });
        if (document.getElementById("isPinned").checked) {
            console.log(document.getElementById("isPinned").checked)
            if (document.getElementById("isPinned").checked) {
                pinUpdate.child(timenow).set(document.getElementById("pinnedMessage").value);
            }
            document.getElementById('pinnedMessage').value = "";
            document.getElementById('isPinned').value = false
        }
        document.getElementById("newMessage").value = "";
    }

    var metaUpdate = firebase.database().ref(EVENT_NAME + '/Metadata');
    metaUpdate.on('value', function (snapshot) {
        meta = snapshot.val()
        // console.log(meta);
        setStatus(meta.Live);
        setBackground(meta.Background);
        setLocation(meta.Location);
        setDescription(meta.Details);
        setFlagship(meta.Flagship);


        function setStatus(isLive) {
            el = document.getElementById("live");
            if (isLive) {
                el.className = "active";
                el.innerHTML = "Live";
                IS_LIVE = 1
            } else {
                el.className = "";
                el.innerHTML = "Offline";
                IS_LIVE = 0;
            }
        }

        function setBackground(backgroundSrc) {
            el = document.getElementById("background-img");
            el.value = backgroundSrc
        }

        function setLocation(location) {
            el = document.getElementById("location");
            el.value = location;
        }

        function setDescription(description) {
            el = document.getElementById("brief");
            el.value = description;
        }


        TBA_EVENT = meta["tba-key"];
        const matchreq = new XMLHttpRequest();
        const matchurl = 'https://www.thebluealliance.com/api/v3/team/frc334/event/' + TBA_EVENT +
            '/matches/simple';
        matchreq.open("GET", matchurl);
        matchreq.setRequestHeader('X-TBA-Auth-Key',
            '2nsVUNsKfMeKvg7XSp04C6VM3uD82da0fVt2ZkpVhSfI8AmM8kZWLwmAdJswRPZc');
        matchreq.send();
        matchreq.onreadystatechange = (e) => {
            if (matchreq.responseText && matchreq.readyState == 4 && matchreq.status == 200) {
                populateTBAScores(matchreq.responseText);
            }
        }
    });

    function setFlagship(flagship) {
        el = document.getElementById("flagship");
        el.value = flagship;
    }

    function updateMeta() {
        metaUpdate.update({
            Background: document.getElementById("background-img").value,
            Details: document.getElementById('brief').value,
            Flagship: document.getElementById("flagship").value,
            Location: document.getElementById('location').value,
        })
    }

    function toggleLiveStatus() {
        metaUpdate.update({
            Live: ((IS_LIVE) ? 0 : 1)
        })
    }

    Element.prototype.appendAfter = function (element) {
        element.parentNode.insertBefore(this, element.nextSibling);
    }, false


    function populateTBAScores(response) {
        formatTeamNum = (Snum) => {
            num = Snum.slice(3, 6);
            return (num == "334") ? "<b> " + num + " </b>" : " " + num + " "
        }

        isMatchWon = (match) => {
            if (match.winning_alliance == "blue") return "blue-won"
            else if (match.winning_alliance == "red") return "red-won"
        }

        response = JSON.parse(response);
        console.log(response);

        var byTime = response.slice(0);
        byTime.sort(function (a, b) {
            return a.predicted_time - b.predicted_time;
        });
        console.log(byTime);
        TBA_RESPONSE = byTime;
        for (match in byTime) {
            numm = match;
            match = byTime[match];
            el = document.createElement("div");
            el.className = "match";
            switch (match.comp_level) {
                case "qm":
                    comp_level = "Qualifying";
                    break;
                case "qf":
                    comp_level = "Quaterfinal";
                    break;
                case "sf":
                    comp_level = "Semifinal";
                    break;
                case "f":
                    comp_level = "Final";
                    break;
                default:
                    comp_level = "Special";
                    break;
            }
            document.querySelector('#tba-matches').innerHTML +=
                `<div class="match ` + isMatchWon(match) + `">
            ` + comp_level + ` Match #` + match.match_number +
                `<br>
            <div class="match-content">
                <div class="red team">
                    <span class="teams">` +
                formatTeamNum(match.alliances.red.team_keys[0]) + formatTeamNum(match.alliances.red.team_keys[1]) +
                formatTeamNum(match.alliances.red.team_keys[2]) +
                `</span><br>
                    <span class="score">` + ((match.alliances.red.score != -1) ? match.alliances
                    .red.score : "NA") +
                `</span>
                </div>VS.
                <div class="blue team">
                    <span class="teams">` +
                formatTeamNum(match.alliances.blue.team_keys[0]) + formatTeamNum(match.alliances.blue.team_keys[1]) +
                formatTeamNum(match.alliances.blue.team_keys[2]) +
                `</span><br>
                    <span class="score">` + ((match.alliances.blue.score != -1) ? match.alliances
                    .blue.score : "NA") +
                `</span>
                </div>
            </div>
            <button id="addMatch" style="height:auto; width: auto;" onclick="addMatch(` +
                numm + `)">Add match ` + match.match_number + `</button>
        </div>`;
        }
    }

    function addMatch(matchval) {
        matchdata = TBA_RESPONSE[matchval]
        console.log(matchdata);
        match = matchdata;
        timenow = parseInt(String(matchdata.actual_time+"000"));
        dataUpdate.child(timenow).set({
            Author: "The Blue Alliance.com",
            Pinned: false,
            ID: timenow,
            Post: document.getElementById("newMessage").value + ((document.getElementById("newMessage").value !=
                    "") ? '<br>' : "") + `<div class="match ` + isMatchWon(match) + `">
            ` +
                comp_level + ` Match #` + match.match_number +
                `<br>
            <div class="match-content">
                <div class="red team">
                    <span class="teams">` +
                formatTeamNum(match.alliances.red.team_keys[0]) + formatTeamNum(match.alliances.red.team_keys[1]) +
                formatTeamNum(match.alliances.red.team_keys[2]) +
                `</span><br>
                    <span class="score">` + ((match.alliances.red.score != -1) ?
                    match.alliances
                    .red.score : "NA") +
                `</span>
                </div>VS.
                <div class="blue team">
                    <span class="teams">` +
                formatTeamNum(match.alliances.blue.team_keys[0]) + formatTeamNum(match.alliances.blue.team_keys[
                    1]) +
                formatTeamNum(match.alliances.blue.team_keys[2]) +
                `</span><br>
                    <span class="score">` + ((match.alliances.blue.score != -1) ?
                    match.alliances
                    .blue.score : "NA") +
                `</span>
                </div>
            </div>
        </div>`,
            type: 'tba',
        });
        document.getElementById("newMessage").value = "";
    }
</script>

<style>
    .chatbox {
        background-color: #EEEEEE;
        width: 100%;
        padding: 20px;
        border-radius: 20px;
    }

    .posts {
        height: 90%;
        overflow: scroll;
    }

    .event-title {
        float: right;
    }

    #live {
        margin: 20px;
    }

    #newMessage {
        width: 100%;
    }

    .active {
        animation-name: live;
        animation-duration: 2s;
        animation-iteration-count: infinite;
        color: white;
    }

    @keyframes live {
        0% {
            background-color: rgba(200, 0, 0, 0.8)
        }

        50% {
            background-color: rgba(255, 0, 0, 0.8)
        }

        100% {
            background-color: rgba(200, 0, 0, 0.8)
        }
    }

    .inp {
        position: relative;
        margin: auto;
        width: 100%;
        max-width: 280px;
    }

    .inp .label {
        position: absolute;
        top: 16px;
        left: 0;
        font-size: 16px;
        color: #9098a9;
        font-weight: 500;
        transform-origin: 0 0;
        transition: all 0.2s ease;
    }

    .inp .border {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        width: 100%;
        background: #07f;
        transform: scaleX(0);
        transform-origin: 0 0;
        transition: all 0.15s ease;
    }

    .inp input {
        -webkit-appearance: none;
        width: 100%;
        border: 0;
        font-family: inherit;
        padding: 12px 0;
        height: 48px;
        font-size: 16px;
        font-weight: 500;
        border-bottom: 2px solid #c8ccd4;
        background: none;
        border-radius: 0;
        color: #223254;
        transition: all 0.15s ease;
    }

    .inp input:hover {
        background: rgba(34, 50, 84, 0.03);
    }

    .inp input:not(:placeholder-shown)+span {
        color: #5a667f;
        transform: translateY(-26px) scale(0.75);
    }

    .inp input:focus {
        background: none;
        outline: none;
    }

    .inp input:focus+span {
        color: #07f;
        transform: translateY(-26px) scale(0.75);
    }

    .inp input:focus+span+.border {
        transform: scaleX(1);
    }
</style>